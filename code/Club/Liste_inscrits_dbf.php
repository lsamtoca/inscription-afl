<?php


/* Format du ficheir dbf --

          VOILE1                C       9       0            
          VOILE2                C       9       0            
          CODE_PAYS             C       3       0            
          INS_EN                C       3       0            
          BAT_NOM1              C       40      0            
          BAT_NOM2              C       30      0            
          BAT_TYPE              C       30      0            
          RANG                  N       522     0            
          POINTS                N       522     0            
          NB_EQUIP              N       2       0            
          GROUPE                C       3       0            
          GROUPE_LIB            C       20      0            
          CLAS_CAT              C       5       0            
          HN_CLASSE             C       2       0            
          HN_BRUT               N       517     0            
          HN_NET                N       517     0            
          HN_BONI               N       260     0            
          HN_PENAL              N       260     0            
          HN_COEF_TT            N       1030    0            
          HN_SEC_TD             N       3       0            
          HN_CVL                N       517     0            
          ACV_COEF              N       1030    0            
          ACV_SEC_TD            N       3       0            
          CIM_COEF              N       3       0            
          CIM_BONI              N       1030    0            
          CIM_PENA              N       518     0            
          ORC_GPH               N       518     0            
          ORC_TMF               N       1030    0            
          ORC_A1                N       1030    0            
          ORC_B1                N       518     0            
          ORC_A2                N       1030    0            
          ORC_B2                N       518     0            
          IRC_COEF              N       1030    0            
          IRC_SEC_TD            N       3       0            
          VLC_COEF              N       1030    0            
          VLC_RAT               N       1030    0            
          E1_NOM                C       30      0            
          E1_PRE                C       15      0            
          E1_SEXE               C       1       0            
          E1_NAIS               C       4       0            
          E1_LIC                C       8       0            
          E1_CLUB               C       5       0            
          E1_CLUB_LI            C       20      0            
          E1_PAYS               C       3       0            
          E1_ISAF               C       10      0            
          E2_NOM                C       18      0            
          E2_PRE                C       15      0            
          E2_SEXE               C       1       0            
          E2_NAIS               C       4       0            
          E2_LIC                C       8       0            
          E2_CLUB               C       5       0            
          E2_PAYS               C       3       0            
          E2_ISAF               C       10      0            
          E3_NOM                C       18      0            
          E3_PRE                C       15      0            
          E3_SEXE               C       1       0            
          E3_NAIS               C       4       0            
          E3_LIC                C       8       0            
          E3_CLUB               C       5       0            
          E3_PAYS               C       3       0            
          E3_ISAF               C       10      0            
          E4_NOM                C       18      0            
          E4_PRE                C       15      0            
          E4_SEXE               C       1       0            
          E4_NAIS               C       4       0            
          E4_LIC                C       8       0            
          E4_CLUB               C       5       0            
          E4_PAYS               C       3       0            
          E4_ISAF               C       10      0            
          E5_NOM                C       18      0            
          E5_PRE                C       15      0            
          E5_SEXE               C       1       0            
          E5_NAIS               C       4       0            
          E5_LIC                C       8       0            
          E5_CLUB               C       5       0            
          E5_PAYS               C       3       0            
          E5_ISAF               C       10      0            
          E6_NOM                C       18      0            
          E6_PRE                C       15      0            
          E6_SEXE               C       1       0            
          E6_NAIS               C       4       0            
          E6_LIC                C       8       0            
          E6_CLUB               C       5       0            
          E6_PAYS               C       3       0            
          E6_ISAF               C       10      0            
          E7_NOM                C       18      0            
          E7_PRE                C       15      0            
          E7_SEXE               C       1       0            
          E7_NAIS               C       4       0            
          E7_LIC                C       8       0            
          E7_CLUB               C       5       0            
          E7_PAYS               C       3       0            
          E7_ISAF               C       10      0            
          E8_NOM                C       18      0            
          E8_PRE                C       15      0            
          E8_SEXE               C       1       0            
          E8_NAIS               C       4       0            
          E8_LIC                C       8       0            
          E8_CLUB               C       5       0            
          E8_PAYS               C       3       0            
          E8_ISAF               C       10      0            
          E9_NOM                C       18      0            
          E9_PRE                C       15      0            
          E9_SEXE               C       1       0            
          E9_NAIS               C       4       0            
          E9_LIC                C       8       0            
          E9_CLUB               C       5       0            
          E9_PAYS               C       3       0            
          E9_ISAF               C       10      0            
          E10_NOM               C       18      0            
          E10_PRE               C       15      0            
          E10_SEXE              C       1       0            
          E10_NAIS              C       4       0            
          E10_LIC               C       8       0            
          E10_CLUB              C       5       0            
          E10_PAYS              C       3       0            
          E10_ISAF              C       10      0            
          AD_RUE1               C       35      0            
          AD_RUE2               C       35      0            
          AD_CODP               C       5       0            
          AD_VILLE              C       30      0            
          PHONE                 C       20      0            
          DATE_MAJ              D       8       0            
*/
/* Champs du fichier INS_DBF.DBF produit par FREG
VOILE1,C,9	
VOILE2,C,9	
CODE_PAYS,C,3	
INS_EN,C,3	
BAT_NOM1,C,40	
BAT_NOM2,C,30	
BAT_TYPE,C,30	
RANG,N,10,2	
POINTS,N,10,2	
NB_EQUIP,N,2,0	
GROUPE,C,3	
GROUPE_LIB,C,20	
CLAS_CAT,C,5	
HN_CLASSE,C,2	
HN_BRUT,N,5,2	
HN_NET,N,5,2	
HN_BONI,N,4,1	
HN_PENAL,N,4,1	
HN_COEF_TT,N,6,4	
HN_SEC_TD,N,3,0	
HN_CVL,N,5,2	
ACV_COEF,N,6,4	
ACV_SEC_TD,N,3,0	
CIM_COEF,N,3,0	
CIM_BONI,N,6,4	
CIM_PENA,N,6,2	
ORC_GPH,N,6,2	
ORC_TMF,N,6,4	
ORC_A1,N,6,4	
ORC_B1,N,6,2	
ORC_A2,N,6,4	
ORC_B2,N,6,2	
IRC_COEF,N,6,4	
IRC_SEC_TD,N,3,0	
VLC_COEF,N,6,4	
VLC_RAT,N,6,4	
E1_NOM,C,30	
E1_PRE,C,15	
E1_SEXE,C,1	
E1_NAIS,C,4	
E1_LIC,C,8	
E1_CLUB,C,5	
E1_CLUB_LI,C,20	
E1_PAYS,C,3	
E1_ISAF,C,10	
E2_NOM,C,18	 E2_PRE,C,15	E2_SEXE,C,1	 E2_NAIS,C,4	E2_LIC,C,8	E2_CLUB,C,5	E2_PAYS,C,3	E2_ISAF,C,10	
E3_NOM,C,18	E3_PRE,C,15	E3_SEXE,C,1	E3_NAIS,C,4	E3_LIC,C,8	E3_CLUB,C,5	E3_PAYS,C,3	E3_ISAF,C,10	
E4_NOM,C,18	E4_PRE,C,15	E4_SEXE,C,1	E4_NAIS,C,4	E4_LIC,C,8	E4_CLUB,C,5	E4_PAYS,C,3	E4_ISAF,C,10	
E5_NOM,C,18	E5_PRE,C,15	E5_SEXE,C,1	E5_NAIS,C,4	E5_LIC,C,8	E5_CLUB,C,5	E5_PAYS,C,3	E5_ISAF,C,10	
E6_NOM,C,18	E6_PRE,C,15	E6_SEXE,C,1	E6_NAIS,C,4	E6_LIC,C,8	E6_CLUB,C,5	E6_PAYS,C,3	E6_ISAF,C,10	
E7_NOM,C,18	E7_PRE,C,15	E7_SEXE,C,1	E7_NAIS,C,4	E7_LIC,C,8	E7_CLUB,C,5	E7_PAYS,C,3	E7_ISAF,C,10	
E8_NOM,C,18	E8_PRE,C,15	E8_SEXE,C,1	E8_NAIS,C,4	E8_LIC,C,8	E8_CLUB,C,5	E8_PAYS,C,3	E8_ISAF,C,10	
E9_NOM,C,18	E9_PRE,C,15	E9_SEXE,C,1	E9_NAIS,C,4	E9_LIC,C,8	E9_CLUB,C,5	E9_PAYS,C,3	E9_ISAF,C,10	
E10_NOM,C,18	E10_PRE,C,15	E10_SEXE,C,1	E10_NAIS,C,4	E10_LIC,C,8	E10_CLUB,C,5	E10_PAYS,C,3	E10_ISAF,C,10	
AD_RUE1,C,35	
AD_RUE2,C,35	
AD_CODP,C,5	
AD_VILLE,C,30	
PHONE,C,20	
DATE_MAJ,D

*/

// unix_base and racine should be defined in

define("FILENAME",sprintf("%sinscrits.dbf",$unix_base.$racine)); //constante: nom du fichier à générer

// Below : done from text above by regular expression and substition in emacs ...
$fields =array(
        array('VOILE1','C','9'),
        array('VOILE2','C','9'),
        array('CODE_PAYS','C','3'),
        array('INS_EN','C','3'),
        array('BAT_NOM1','C','40'),
        array('BAT_NOM2','C','30'),
        array('BAT_TYPE','C','30'),
        array('RANG','N','10','2'), //Modif
        array('POINTS','N','10','2'), //Modif
        array('NB_EQUIP','N','2','0'),
        array('GROUPE','C','3'),
        array('GROUPE_LIB','C','20'),
        array('CLAS_CAT','C','5'),
// HN_CLASSE,C,2	HN_BRUT,N,5,2	HN_NET,N,5,2	HN_BONI,N,4,1	HN_PENAL,N,4,1	HN_COEF_TT,N,6,4	HN_SEC_TD,N,3,0	HN_CVL,N,5,2
        array('HN_CLASSE','C','2'),
        array('HN_BRUT','N','5','2'),
        array('HN_NET','N','5','2'),
        array('HN_BONI','N','4','1'),
        array('HN_PENAL','N','4','1'),
        array('HN_COEF_TT','N','6','4'),
        array('HN_SEC_TD','N','3','0'),
        array('HN_CVL','N','5','2'),
// ACV_COEF,N,6,4	ACV_SEC_TD,N,3,0
        array('ACV_COEF','N','6','0'),
        array('ACV_SEC_TD','N','3','0'),
//CIM_COEF,N,3,0	CIM_BONI,N,6,4	CIM_PENA,N,6,2
        array('CIM_COEF','N','3','0'),
        array('CIM_BONI','N','6','4'),
        array('CIM_PENA','N','6','2'),
//ORC_GPH,N,6,2	ORC_TMF,N,6,4	ORC_A1,N,6,4	ORC_B1,N,6,2	ORC_A2,N,6,4	ORC_B2,N,6,2
        array('ORC_GPH','N','6','2'),
        array('ORC_TMF','N','6','4'),
        array('ORC_A1','N','6','4'),
        array('ORC_B1','N','6','2'),
        array('ORC_A2','N','6','4'),
        array('ORC_B2','N','6','2'),
//IRC_COEF,N,6,4	IRC_SEC_TD,N,3,0
        array('IRC_COEF','N','6','4'),
        array('IRC_SEC_TD','N','3','0'),
// VLC_COEF,N,6,4	VLC_RAT,N,6,4
        array('VLC_COEF','N','6','4'),
        array('VLC_RAT','N','6','4'),
        array('E1_NOM','C','30'),
        array('E1_PRE','C','15'),
        array('E1_SEXE','C','1'),
        array('E1_NAIS','C','4'),
        array('E1_LIC','C','8'),
        array('E1_CLUB','C','5'),
        array('E1_CLUB_LI','C','20'),
        array('E1_PAYS','C','3'),
        array('E1_ISAF','C','10'),
        array('E1_EMAIL','C','60'),
        array('E2_NOM','C','18'),
        array('E2_PRE','C','15'),
        array('E2_SEXE','C','1'),
        array('E2_NAIS','C','4'),
        array('E2_LIC','C','8'),
        array('E2_CLUB','C','5'),
        array('E2_PAYS','C','3'),
        array('E2_ISAF','C','10'),
        array('E2_EMAIL','C','60'),
        array('E3_NOM','C','18'),
        array('E3_PRE','C','15'),
        array('E3_SEXE','C','1'),
        array('E3_NAIS','C','4'),
        array('E3_LIC','C','8'),
        array('E3_CLUB','C','5'),
        array('E3_PAYS','C','3'),
        array('E3_ISAF','C','10'),
        array('E3_EMAIL','C','60'),
        array('E4_NOM','C','18'),
        array('E4_PRE','C','15'),
        array('E4_SEXE','C','1'),
        array('E4_NAIS','C','4'),
        array('E4_LIC','C','8'),
        array('E4_CLUB','C','5'),
        array('E4_PAYS','C','3'),
        array('E4_ISAF','C','10'),
        array('E4_EMAIL','C','60'),
        array('E5_NOM','C','18'),
        array('E5_PRE','C','15'),
        array('E5_SEXE','C','1'),
        array('E5_NAIS','C','4'),
        array('E5_LIC','C','8'),
        array('E5_CLUB','C','5'),
        array('E5_PAYS','C','3'),
        array('E5_ISAF','C','10'),
        array('E5_EMAIL','C','60'),
        array('E6_NOM','C','18'),
        array('E6_PRE','C','15'),
        array('E6_SEXE','C','1'),
        array('E6_NAIS','C','4'),
        array('E6_LIC','C','8'),
        array('E6_CLUB','C','5'),
        array('E6_PAYS','C','3'),
        array('E6_ISAF','C','10'),
        array('E6_EMAIL','C','60'),
        array('E7_NOM','C','18'),
        array('E7_PRE','C','15'),
        array('E7_SEXE','C','1'),
        array('E7_NAIS','C','4'),
        array('E7_LIC','C','8'),
        array('E7_CLUB','C','5'),
        array('E7_PAYS','C','3'),
        array('E7_ISAF','C','10'),
        array('E7_EMAIL','C','60'),
        array('E8_NOM','C','18'),
        array('E8_PRE','C','15'),
        array('E8_SEXE','C','1'),
        array('E8_NAIS','C','4'),
        array('E8_LIC','C','8'),
        array('E8_CLUB','C','5'),
        array('E8_PAYS','C','3'),
        array('E8_ISAF','C','10'),
        array('E8_EMAIL','C','60'),
        array('E9_NOM','C','18'),
        array('E9_PRE','C','15'),
        array('E9_SEXE','C','1'),
        array('E9_NAIS','C','4'),
        array('E9_LIC','C','8'),
        array('E9_CLUB','C','5'),
        array('E9_PAYS','C','3'),
        array('E9_ISAF','C','10'),
        array('E9_EMAIL','C','60'),
        array('E10_NOM','C','18'),
        array('E10_PRE','C','15'),
        array('E10_SEXE','C','1'),
        array('E10_NAIS','C','4'),
        array('E10_LIC','C','8'),
        array('E10_CLUB','C','5'),
        array('E10_PAYS','C','3'),
        array('E10_ISAF','C','10'),
        array('E10_EMAIL','C','60'),
// AD_RUE1,C,35	AD_RUE2,C,35	AD_CODP,C,5	AD_VILLE,C,30	PHONE,C,20	DATE_MAJ,D
        array('AD_RUE1','C','35'),
        array('AD_RUE2','C','35'),
        array('AD_CODP','C','5'),
        array('AD_VILLE','C','30'),
        array('PHONE','C','20'),
        array('DATE_MAJ','D')
);


if(file_exists(FILENAME)) unlink (FILENAME); 
$dbf = dbase_create (FILENAME, $fields) or die("Problème de création fichier dbf\n");



function generate_dbf() {

    global $dbf;
    global $fields;


    $condition=sprintf("WHERE  `ID_regate` = '%s'",$_SESSION['ID_regate']);
    if(isset($_GET['confirme']) and $_GET['confirme']=='1')
        $condition.=' AND `conf`=\'1\'';
    $query="SELECT *, DATE_FORMAT(`naissance`,'%Y') as `E1_NAIS` FROM `Inscrit` " .$condition;

    $conn=connect();
    $res=mysql_query($query,$conn) or die('Problème lors de la réception des enregistrements'.$query.mysql_error());//Exécution de la requête
    //$db = dbase_open(FILENAME, 1) or die('Problème l\'ouverture du fichier');

    $correspondence = array(
            'VOILE1' => array('num_voile',''),
            'CODE_PAYS' => array('prefix_voile',''),
            'INS_EN' => array('','VL'),
            'BAT_TYPE' => array('serie',''),
            'NB_EQUIP' => array('','1'),
            'GROUPE' => array('serie',''),
            'CLAS_CAT' => array('serie',''),
            'E1_NOM' => array('nom',''),
            'E1_PRE' => array('prenom',''),
            'E1_SEXE' => array('sexe',''),
            'E1_NAIS' => array('E1_NAIS',''),
            'E1_LIC' => array('num_lic',''),
            'E1_ISAF' => array('isaf_no',''),
            'E1_CLUB' => array('num_club',''),
            'E1_CLUB_LI' => array('nom_club',''),
            'E1_PAYS' => array('prefix_voile',''),
            'E1_EMAIL' => array('mail','')
    );

    setlocale(LC_ALL, 'fr_FR');

    while($row=mysql_fetch_assoc($res)) {//Parcours du résultat de la requête

        $i=0;
        foreach($fields as $field) {

            if(isset($correspondence[$field[0]])) {
                $value=$correspondence[$field[0]];

                if($value[1] == '') {
                    // $record[$i] = $row[$value[0]];
                    //$record[$i]= utf8_decode($row[$value[0]]);
                    $ascii_str = $row[$value[0]];
                    if(($value[0] == 'prenom') or ($value[0] == 'nom'))
                        $ascii_str = strtoupper($ascii_str);
                    $record[$i] = iconv('UTF-8', 'ASCII//TRANSLIT', $ascii_str);
                }
                else
                    $record[$i]= $value[1];
            }
            else $record[$i]= '';

            $i++;
        }
        if(!dbase_add_record ($dbf, $record)) echo "Problème addition de record";
    }

    mysql_close($conn);
    dbase_close($dbf);

}

generate_dbf();

// Redirect output to a client’s web browser (Excel5)
header('Content-Type: application/vnd.ms-excel');
header('Content-Disposition: attachment;filename="ins_dbf.dbf"');
header('Cache-Control: max-age=0');
readfile(FILENAME);

exit;


?>